<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="lvm实践, 小二来了">
    <meta name="description" content="工作原理lvm（Logical Volume Manager ）称为逻辑卷管理器，主要用来解决传统磁盘分区方式（先对磁盘进行分区，对分区进行文件系统格式化，将文件系统进行挂载使用）扩缩容不够灵活从而导致后期可能出现的磁盘空间不足等其它问题。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    <style>
        body{
            background-image: url(https://cdn.hk01.com/di/media/images/dw/20200921/384697236124209152.jpeg/t2I1OxA0i0hRyF28TQrl1bi2xTRkVkC11-CCodfggqE?v=w1920);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>


    <title>lvm实践 | 小二来了</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小二来了" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小二来了</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小二来了</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/bestmem/bestmem.github.io.git" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/bestmem/bestmem.github.io.git" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">lvm实践</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/linux/">
                                <span class="chip bg-color">linux</span>
                            </a>
                        
                            <a href="/tags/lvm/">
                                <span class="chip bg-color">lvm</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/linux/" class="post-category">
                                linux
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-09-01
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-09-07
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    33 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p>lvm（Logical Volume Manager ）称为逻辑卷管理器，主要用来解决传统磁盘分区方式（先对磁盘进行分区，对分区进行文件系统格式化，将文件系统进行挂载使用）扩缩容不够灵活从而导致后期可能出现的磁盘空间不足等其它问题。</p>
<p>如：在项目初期磁盘空间使用规划中，低估了业务的数据增长量，同时采用传统磁盘分区管理方式进行存储业务数据，导致后期磁盘分区空间不足。这时如果想要扩展磁盘空间，只能新增硬盘，创建分区、文件系统，然后将之前磁盘分区文件系统中的数据迁移过来，这无疑会导致业务中断，而且也并不是在原有的分区上进行扩容。</p>
<p>而如果采用了lvm，我们便可以对磁盘空间进行动态管理（扩容和缩容），lvm机制涉及的关键点主要有：</p>
<ul>
<li><p>PE（Physical Extend）</p>
<p>物理扩展，是lvm中的最小存储单元，其大小在在创建卷组时确定，一旦确定不可改变。通常为4.00 MiB</p>
<blockquote>
<p>pe大，读取速度快，但浪费空间；pe小，读取速度慢，但节省空间</p>
</blockquote>
</li>
<li><p>LE（Logical Extent）</p>
<p>逻辑扩展，是逻辑卷可用于分配的最小存储单元，le的大小取决于lv所在vg中的pe的大小，大小等于pe，只不过在lv中称为le。</p>
</li>
<li><p>PV（physical volume）</p>
<p>物理卷，其来源可为一整个磁盘（/dev/sda）或磁盘分区（/dev/sda1），要使用lvm磁盘管理方式，第一步便是先将磁盘创建为pv中。</p>
<blockquote>
<p>注：在老版本的linux中使用磁盘分区创建PV时，需要设置该磁盘分区类型为8e（Linux LVM），但在新版本中已经不需要特别设置了，即使是默认的83（Linux）类型，也可创建为pv。<br>默认我们还是修改为8e，养成一个良好的习惯。</p>
</blockquote>
</li>
<li><p>VG（volume group）</p>
<p>卷组，是物理卷和逻辑卷的中间部分，卷组由多个pv组成，其空间大小等于所有组成卷组的pv之和，在卷组之上可以创建lv。</p>
</li>
<li><p>LV（logical volume）</p>
<p>逻辑卷，在卷组上创建完成之后，对lv进行文件系统格式化后，可挂载使用。lvm的扩缩容实际就是增加或减少组成该lv的pe数量。</p>
</li>
</ul>
<p>如下图所示：</p>
<h1 id="添加硬盘"><a href="#添加硬盘" class="headerlink" title="添加硬盘"></a>添加硬盘</h1><p>默认新增的硬盘需要重启服务器才可识别出来，是因为重启的使用系统是会重新扫描磁盘设备，也可通过如下方式强制系统重新扫描磁盘设备，从而识别到新添加的硬盘</p>
<pre class="line-numbers language-none"><code class="language-none"># 列出scsi设备的
[root@132 ~]# ls /sys/class/scsi_host/
host0  host1  host2
[root@132 ~]# echo "- - -" &gt; /sys/class/scsi_host/host0/scan
[root@132 ~]# echo "- - -" &gt; /sys/class/scsi_host/host1/scan
[root@132 ~]# echo "- - -" &gt; /sys/class/scsi_host/host2/scan<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="pv"><a href="#pv" class="headerlink" title="pv"></a>pv</h2><h3 id="pvcreate"><a href="#pvcreate" class="headerlink" title="pvcreate"></a>pvcreate</h3><p>可以将一整块磁盘或磁盘分区创建为物理卷。</p>
<p><strong>整块磁盘</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ pvcreate /dev/sdb
  Physical volume "/dev/sdb" successfully created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>磁盘分区</strong></p>
<p><img src="/2022/09/01/linux/%E7%A3%81%E7%9B%98/lvm%E5%AE%9E%E8%B7%B5/image-20220901145730046.png" alt="image-20220901145730046"></p>
<pre class="line-numbers language-none"><code class="language-none">$ pvcreate /dev/sdb1
  Physical volume "/dev/sdb1" successfully created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="pvscan"><a href="#pvscan" class="headerlink" title="pvscan"></a>pvscan</h3><p>用于扫描已存在的pv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvscan
  PV /dev/sda2   VG centos          lvm2 [&lt;19.00 GiB / 0    free]
  PV /dev/sdc    VG centos          lvm2 [&lt;15.00 GiB / &lt;3.00 GiB free]
  PV /dev/sdb1                      lvm2 [&lt;20.00 GiB]
  Total: 3 [53.99 GiB] / in use: 2 [33.99 GiB] / in no VG: 1 [&lt;20.00 GiB]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pvs"><a href="#pvs" class="headerlink" title="pvs"></a>pvs</h3><p>简单查询已存在的pv信息，后面可跟具体的pv名。</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvs
  PV         VG     Fmt  Attr PSize   PFree
  /dev/sda2  centos lvm2 a--  &lt;19.00g      0
  /dev/sdb1         lvm2 ---  &lt;20.00g &lt;20.00g
  /dev/sdc   centos lvm2 a--  &lt;15.00g  &lt;3.00g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pvdisplay"><a href="#pvdisplay" class="headerlink" title="pvdisplay"></a>pvdisplay</h3><p>查询pv的详细信息。</p>
<p><img src="/2022/09/01/linux/%E7%A3%81%E7%9B%98/lvm%E5%AE%9E%E8%B7%B5/image-20220901151032887.png" alt="image-20220901151032887"></p>
<p>通过<code>-m|--maps</code>参数可显示le（逻辑扩展）和pv上pe（物理扩展）的映射关系，可用于pvmove数据迁移：</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvdisplay -m /dev/sdb
  --- Physical volume ---
  PV Name               /dev/sdb
  VG Name               mydata
  PV Size               20.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               3839
  Allocated PE          1280
  PV UUID               IFeeR7-uuTg-fP9T-Nbck-9y8M-X0n0-Qut9hU

  --- Physical Segments ---
  Physical extent 0 to 1279:
    Logical volume      /dev/mydata/logs1
    Logical extents     0 to 1279
  Physical extent 1280 to 5118:
    FREE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pvremove"><a href="#pvremove" class="headerlink" title="pvremove"></a>pvremove</h3><p>将已创建的pv移除，需确保该pv未加入任何vg组。</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvremove /dev/sdb1
  Labels on physical volume "/dev/sdb1" successfully wiped.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="pvmove"><a href="#pvmove" class="headerlink" title="pvmove"></a>pvmove</h3><p>迁移pv中的数据。试想当我们的pv加入了某一vg，创建了lv并且格式化文件系统挂载后，已有数据存储在该pv所在的磁盘，这时你想将某一pv所在的磁盘归还，那么就涉及到将该pv所在磁盘的数据迁移到其他pv所在的磁盘。</p>
<p>如：现在有两个pv，分别对应着/dev/sdb和/dev/sdc磁盘，共同属于mydata卷组，且在该卷组上创建了logs1逻辑卷，格式化文件系统类型为ext4，其上存储着2G的数据：</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvs
  PV         VG     Fmt  Attr PSize   PFree
  /dev/sdb   mydata lvm2 a--  &lt;20.00g &lt;15.00g
  /dev/sdc   mydata lvm2 a--  &lt;15.00g &lt;15.00g
$ vgs
  VG     #PV #LV #SN Attr   VSize   VFree
  mydata   2   1   0 wz--n-  34.99g 29.99g
$ lvs
  LV    VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  logs1 mydata -wi-ao----   5.00g
$ [root@132 logs]# df -h
/dev/mapper/mydata-logs1  4.8G  2.1G  2.6G   45% /mnt/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时我们需要归还物理卷/dev/sdb所在的磁盘，我们尝试从卷组mydata中删除/dev/sdb物理卷：</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgreduce mydata /dev/sdb
  Physical volume "/dev/sdb" still in use<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>无法删除，提示该pv在使用中，说明有lv中的数据存储在该pv中，查看pv详细信息：</p>
<pre class="line-numbers language-none"><code class="language-none">$  pvdisplay -m /dev/sdb
  --- Physical volume ---
  PV Name               /dev/sdb
  VG Name               mydata
  PV Size               20.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               3839
  Allocated PE          1280
  PV UUID               IFeeR7-uuTg-fP9T-Nbck-9y8M-X0n0-Qut9hU

  --- Physical Segments ---
  Physical extent 0 to 1279:
    Logical volume      /dev/mydata/logs1
    Logical extents     0 to 1279
  Physical extent 1280 to 5118:
    FREE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到有1280个pe在被使用中，同时在<code>Physical Segments</code>中可以看到pe:0-1279对应着le:0-1279在被使用中，所以我们需要迁移这部分的数据：</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvmove /dev/sdb:0-1279 /dev/sdc
  /dev/sdb: Moved: 0.31%
  /dev/sdb: Moved: 100.00%
$ pvdisplay /dev/sdb /dev/sdc
  --- Physical volume ---
  PV Name               /dev/sdb
  VG Name               mydata
  PV Size               20.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               5119
  Allocated PE          0
  PV UUID               IFeeR7-uuTg-fP9T-Nbck-9y8M-X0n0-Qut9hU

  --- Physical volume ---
  PV Name               /dev/sdc
  VG Name               mydata
  PV Size               15.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              3839
  Free PE               2559
  Allocated PE          1280
  PV UUID               5Xu1I1-IrQD-uMPH-BLfm-GEB9-hIJ9-6NARLs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>迁移完成后，便可以从vg中删除该pv：</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgreduce mydata /dev/sdb
  Removed "/dev/sdb" from volume group "mydata"
$ pvremove /dev/sdb
  Labels on physical volume "/dev/sdb" successfully wiped.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="vg"><a href="#vg" class="headerlink" title="vg"></a>vg</h2><h3 id="vgcreate"><a href="#vgcreate" class="headerlink" title="vgcreate"></a>vgcreate</h3><p>创建vg，需要有空闲的pv（即未加入任何vg的pv）。</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgcreate mydata /dev/sdb1
  Volume group "mydata" successfully created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="vgscan"><a href="#vgscan" class="headerlink" title="vgscan"></a>vgscan</h3><p>扫描已经存在的vg</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgscan
  Reading volume groups from cache.
  Found volume group "mydata" using metadata type lvm2
  Found volume group "centos" using metadata type lvm2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="vgs"><a href="#vgs" class="headerlink" title="vgs"></a>vgs</h3><p>简单查询已存在的vg信息，后面可跟具体的vg名。</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgs
  VG     #PV #LV #SN Attr   VSize   VFree
  centos   2   3   0 wz--n-  33.99g  &lt;3.00g
  mydata   1   0   0 wz--n- &lt;20.00g &lt;20.00g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="vgdisplay"><a href="#vgdisplay" class="headerlink" title="vgdisplay"></a>vgdisplay</h3><p>查询vg的详细信息。</p>
<p><img src="/2022/09/01/linux/%E7%A3%81%E7%9B%98/lvm%E5%AE%9E%E8%B7%B5/image-20220901173300330.png" alt="image-20220901173300330"></p>
<h3 id="vgremove"><a href="#vgremove" class="headerlink" title="vgremove"></a>vgremove</h3><p>移除已存在的vg，需确保该vg未创建任何lv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgremove mydata
  Volume group "mydata" successfully removed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="vgextend"><a href="#vgextend" class="headerlink" title="vgextend"></a>vgextend</h3><p>扩展vg，即添加新的pv到vg。</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgextend mydata /dev/sdb2
  Volume group "mydata" successfully extended<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="vgreduce"><a href="#vgreduce" class="headerlink" title="vgreduce"></a>vgreduce</h3><p>用来缩减vg，即所属vg中的pv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ vgreduce mydata /dev/sdb2
  Removed "/dev/sdb2" from volume group "mydata"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="lv"><a href="#lv" class="headerlink" title="lv"></a>lv</h2><p>在创建或者扩展lv时，我们指定lv名称即可，在查看lv信息时，名称为完整路径：<code>/dev/vg名称/lv名称</code>。</p>
<h3 id="lvcreate"><a href="#lvcreate" class="headerlink" title="lvcreate"></a>lvcreate</h3><p>创建lv。</p>
<pre class="line-numbers language-none"><code class="language-none">lvcreate -l|-L 分配大小 -n lv名称 使用的vg名称<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>常用参数的区别：</p>
<ol>
<li><p>-L 和-l，-L 指定要创建lv的大小，-l指定创建lv的pe数（可指定具体数量，也可按照百分比分配），我们知道lv实际是由pe组成的，pe默认的大小为4M，因此创建的lv大小只能为pe的整数倍。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvcreate -L 17M -n mydata-logs mydata
  Rounding up size to full physical extent 20.00 MiB
  Logical volume "mydata-logs" created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>可以看到，我们指定的大小为17M，但实际分配的大小为20M。这是因为pe的大小为4M，之能分配整数倍的pe数。这也就是我们之前说的，pe越大，在分配空间时会浪费存储空间。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$ lvcreate -l 4 -n mydata-logs mydata
  Logical volume "mydata-logs" created.
$ lvdisplay /dev/mydata/mydata-logs
  --- Logical volume ---
  LV Path                /dev/mydata/mydata-logs
  LV Name                mydata-logs
  VG Name                mydata
  LV UUID                D0LJ4C-VaNi-0gEd-C3am-SQiN-Vvmn-Z7XVw7
  LV Write Access        read/write
  LV Creation host, time 132.master.k8s, 2022-09-02 09:30:42 +0800
  LV Status              available
  # open                 0
  LV Size                16.00 MiB
  Current LE             4
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>指定pe数为4，则分配的空间大小为16M。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$ lvcreate -l 50%VG -n mydata-logs mydata		# 分配VG中空闲pe数量的一般分配给lv
$ lvcreate -l 100%VG -n mydata-logs mydata		# 将VG中空闲pe全部分配给lv，<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">$ vgdisplay mydata
  --- Volume group ---
  VG Name               mydata
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  15
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               &lt;10.00 GiB
  PE Size               4.00 MiB
  Total PE              2559
  Alloc PE / Size       0 / 0
  Free  PE / Size       2559 / &lt;10.00 GiB
  VG UUID               UrAvf8-1C1J-OYbL-pI0R-W37c-fxWV-cctZNb

$ lvcreate -l 2559 -n mydata-logs mydata
  Logical volume "mydata-logs" created.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>也可通过vgdispaly查询vg总的空闲pe数（Free PE），并将其全部分配给lv。</p>
</blockquote>
<p>这里为什么详细讲了如何将vg的空间全部分配给lv的操作？这是因为该操作你以后可能会经常用，如果只会-L分配空间，那么你可能会遇到下面的情况：</p>
<pre class="line-numbers language-none"><code class="language-none">$  vgs
  VG     #PV #LV #SN Attr   VSize   VFree
  centos   2   3   0 wz--n-  33.99g  &lt;3.00g
  mydata   1   0   0 wz--n- &lt;10.00g &lt;10.00g
$lvcreate -L 10g -n mydata-logs mydata
  Volume group "mydata" has insufficient free space (2559 extents): 2560 required.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>显示小于10G，但是你也不知道具体剩余多大的空间。</p>
</li>
</ol>
<h3 id="lvscan"><a href="#lvscan" class="headerlink" title="lvscan"></a>lvscan</h3><p>扫描已存在的lv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvscan
  ACTIVE            '/dev/centos/swap' [2.00 GiB] inherit
  ACTIVE            '/dev/centos/root' [&lt;17.00 GiB] inherit
  ACTIVE            '/dev/centos/test' [12.00 GiB] inherit
  ACTIVE            '/dev/mydata/mydata-logs' [1.00 GiB] inherit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="lvs"><a href="#lvs" class="headerlink" title="lvs"></a>lvs</h3><p>简单查看lv信息。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvs
  LV          VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root        centos -wi-ao---- &lt;17.00g
  swap        centos -wi-a-----   2.00g
  test        centos -wi-ao----  12.00g
  mydata-logs mydata -wi-a-----   1.00g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="lvdispaly"><a href="#lvdispaly" class="headerlink" title="lvdispaly"></a>lvdispaly</h3><p>查看lv的详细信息。默认查询所有的lv详细信息，可指定具体的lv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvdisplay /dev/mydata/mydata-logs
  --- Logical volume ---
  LV Path                /dev/mydata/mydata-logs
  LV Name                mydata-logs
  VG Name                mydata
  LV UUID                U9ksiC-Dgz2-X8ZX-p5C9-bLLD-TRXn-NjIxbt
  LV Write Access        read/write
  LV Creation host, time 132.master.k8s, 2022-09-02 10:36:12 +0800
  LV Status              available
  # open                 0
  LV Size                1.00 GiB
  Current LE             256
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="lvremove"><a href="#lvremove" class="headerlink" title="lvremove"></a>lvremove</h3><p>删除某一lv，需确保该lv没有被使用。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvremove /dev/mydata/mydata-logs
Do you really want to remove active logical volume mydata/mydata-logs? [y/n]: y
  Logical volume "mydata-logs" successfully removed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="lvextend"><a href="#lvextend" class="headerlink" title="lvextend"></a>lvextend</h3><p>扩展lv，这也是lvm的一大特性，通过增加磁盘，创建为pv，然后加入vg组，可以随时用于扩展lv的大小。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvextend -L 3g  /dev/mydata/mydata-logs
  Size of logical volume mydata/mydata-logs changed from 1.00 GiB (256 extents) to 3.00 GiB (768 extents).
  Logical volume mydata/mydata-logs successfully resized.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>将lv扩展至3G，扩展大小需大于lv当前大小。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$ lvextend -L +3g  /dev/mydata/mydata-logs
  Size of logical volume mydata/mydata-logs changed from 1.00 GiB (256 extents) to 4.00 GiB (1024 extents).
  Logical volume mydata/mydata-logs successfully resized.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>将lv在原有的基础上增加3G。</p>
</blockquote>
<p>也可通过vgdisplay查询剩余pe数，通过-l来指定。</p>
<h3 id="lvreduce"><a href="#lvreduce" class="headerlink" title="lvreduce"></a>lvreduce</h3><p>缩减lv。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvreduce -L -1G /dev/mydata/mydata-logs
  WARNING: Reducing active logical volume to 3.00 GiB.
  THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce mydata/mydata-logs? [y/n]: y
  Size of logical volume mydata/mydata-logs changed from 4.00 GiB (1024 extents) to 3.00 GiB (768 extents).
  Logical volume mydata/mydata-logs successfully resized.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注意：不可贸然对一个lv直接进行缩减，因为该lv可能已经格式化了文件系统，并被使用。</p>
<p>要严格按照缩容流程进行缩容：</p>
<ol>
<li>卸载已经挂载的逻辑卷</li>
<li>缩小文件系统</li>
<li>缩小lv</li>
<li>查看缩小后的lv</li>
<li>重新挂载</li>
</ol>
</blockquote>
<p>针对以上操作可能略显不太方便，且不是动态调整，因此可通过下列动态方式缩容（同时缩小文件系统和lv大小）：</p>
<pre class="line-numbers language-none"><code class="language-none">$ df -h
/dev/mapper/mydata-logs  2.9G  9.0M  2.8G    1% /mnt/logs

$ lvreduce -L -100M -r /dev/mapper/mydata-logs
Do you want to unmount "/mnt/logs" ? [Y|n] y
fsck，来自 util-linux 2.23.2
/dev/mapper/mydata-logs: 11/196608 files (0.0% non-contiguous), 31036/786432 blocks
resize2fs 1.42.9 (28-Dec-2013)
Resizing the filesystem on /dev/mapper/mydata-logs to 760832 (4k) blocks.
The filesystem on /dev/mapper/mydata-logs is now 760832 blocks long.

  Size of logical volume mydata/logs changed from 3.00 GiB (768 extents) to 2.90 GiB (743 extents).
  Logical volume mydata/logs successfully resized.

$ df -h
/dev/mapper/mydata-logs  2.8G  9.0M  2.7G    1% /mnt/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>若已有文件系统，可通过<code>-r</code>参数同时对文件系统进行动态缩容。</p>
</blockquote>
<h3 id="lvresize"><a href="#lvresize" class="headerlink" title="lvresize"></a>lvresize</h3><p>调整lv大小，既可调大也可调小。</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvresize -L 1G /dev/mydata/logs		# 将lv调整到指定大小
$ lvresize -L +100M /dev/mydata/logs	# 将lv增加100M
$ lvresize -L -100M /dev/mydata/logs	# 将lv减少100M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>使用lvresize在进行缩容时，若遇到已有文件系统在使用，也需要严格按照缩容流程进行缩容，参考lvreduce。</p>
</blockquote>
<p>使用动态方式缩容（同时缩小文件系统和lv大小）</p>
<pre class="line-numbers language-none"><code class="language-none">$ df -h
/dev/mapper/mydata-logs  5.8G   24M  5.5G    1% /mnt/logs
$ lvresize --resizefs --size -1G /dev/mydata/logs
Do you want to unmount "/mnt/logs" ? [Y|n] y
fsck，来自 util-linux 2.23.2
/dev/mapper/mydata-logs: 11/393216 files (0.0% non-contiguous), 63598/1572864 blocks
resize2fs 1.42.9 (28-Dec-2013)
Resizing the filesystem on /dev/mapper/mydata-logs to 1310720 (4k) blocks.
The filesystem on /dev/mapper/mydata-logs is now 1310720 blocks long.

  Size of logical volume mydata/logs changed from 6.00 GiB (1536 extents) to 5.00 GiB (1280 extents).
  Logical volume mydata/logs successfully resized.
$ df -h
/dev/mapper/mydata-logs  4.8G   24M  4.6G    1% /mnt/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>--resizefs</code>同时缩小文件系统；<code>--size</code>调整的大小：数值代表调整至多大，+代表增加多少，-代表减少多少。</p>
</blockquote>
<h1 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h1><p>通过lvm创建好了lv之后，需要对lv格式化文件系统，才能挂载使用。</p>
<p>不同的文件系统其特点各不相同，所以你需要事先了解各文件系统的特点，选择适合你的进行使用：</p>
<p>文件系统EXT4和XFS的区别可参考该博客<a target="_blank" rel="noopener" href="http://xiaqunfeng.cc/2017/07/06/XFS-vs-EXT4/%EF%BC%8C%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%AE%B0%E4%BD%8F%E7%9A%84%E4%B8%80%E7%82%B9%EF%BC%9A**xfs%E4%B8%8D%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E7%BC%A9%E5%AE%B9%EF%BC%8C%E8%80%8Cext4%E6%94%AF%E6%8C%81**%E3%80%82">http://xiaqunfeng.cc/2017/07/06/XFS-vs-EXT4/，这里我们需要记住的一点：**xfs不支持动态缩容，而ext4支持**。</a></p>
<p>文件系统格式化：</p>
<pre class="line-numbers language-none"><code class="language-none">创建了lv后，便可对lv格式化文件系统
$ mkfs.ext4 /dev/mydata/logs1			# 格式化为ext4文件系统
$ mkfs -t ext4 /dev/mydata/logs1		# 格式化为ext4文件系统
$ mkfs.xfs /dev/mydata/logs1			# 格式化为xfs文件系统
$ mkfs -t xfs -f /dev/mydata/logs1		# 格式化为xfs文件系统<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>格式化完成后，可进行挂载使用：</p>
<pre class="line-numbers language-none"><code class="language-none">$ mkdir /mnt/logs	# 创建挂载点
$ mount /dev/mapper/mydata-logs1 /mnt/logs/			# 手动挂载

# 永久性挂载（生产）
# 查看该文件系统uuid
$ blkid /dev/mapper/mydata-logs1
/dev/mapper/mydata-logs1: UUID="011e8b4c-7083-4517-89cc-cebdb0fe6c11" TYPE="xfs"
# 在/etc/fstab中添加以下行
$ cat /etc/fstab
UUID=011e8b4c-7083-4517-89cc-cebdb0fe6c11 /mnt/logs     xfs     defaults        0 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="lvm创建"><a href="#lvm创建" class="headerlink" title="lvm创建"></a>lvm创建</h1><table>
<thead>
<tr>
<th>磁盘</th>
<th>磁盘大小</th>
<th>pv</th>
<th>PV大小</th>
<th>vg</th>
</tr>
</thead>
<tbody><tr>
<td>/dev/sdb</td>
<td>20G</td>
<td>/dev/sdb1</td>
<td>10G</td>
<td>mydata</td>
</tr>
<tr>
<td>/dev/sdc</td>
<td>15G</td>
<td>/dev/sdc</td>
<td>15G</td>
<td>mydata</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>lv</th>
<th>所属vg</th>
<th>lv大小</th>
<th>文件系统</th>
<th>挂载点</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>data</td>
<td>mydata</td>
<td>10G</td>
<td>ext4</td>
<td>/data</td>
<td>存储数据</td>
</tr>
<tr>
<td>logs</td>
<td>mydata</td>
<td>10G</td>
<td>xfs</td>
<td>/opt/logs</td>
<td>存储日志</td>
</tr>
</tbody></table>
<p><strong>1、磁盘分区</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# fdisk /dev/sdb
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0xdd41f53c 创建新的 DOS 磁盘标签。

命令(输入 m 获取帮助)：n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p):
Using default response p
分区号 (1-4，默认 1)：
起始 扇区 (2048-41943039，默认为 2048)：
将使用默认值 2048
Last 扇区, +扇区 or +size{K,M,G} (2048-41943039，默认为 41943039)：+10G
分区 1 已设置为 Linux 类型，大小设为 10 GiB

命令(输入 m 获取帮助)：t
已选择分区 1
Hex 代码(输入 L 列出所有代码)：8e
已将分区“Linux”的类型更改为“Linux LVM”

命令(输入 m 获取帮助)：wq
The partition table has been altered!

Calling ioctl() to re-read partition table.
正在同步磁盘。
[root@132 ~]# partprobe
Warning: 无法以读写方式打开 /dev/sr0 (只读文件系统)。/dev/sr0 已按照只读方式打开。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2、创建pv</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# pvcreate /dev/sdb1
WARNING: ext4 signature detected on /dev/sdb1 at offset 1080. Wipe it? [y/n]: y
  Wiping ext4 signature on /dev/sdb1.
  Physical volume "/dev/sdb1" successfully created.
[root@132 ~]# pvcreate /dev/sdc
  Physical volume "/dev/sdc" successfully created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3、创建vg</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# vgcreate mydata /dev/sdb1
  Volume group "mydata" successfully created
[root@132 ~]# vgextend mydata /dev/sdc
  Volume group "mydata" successfully extended<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>4、创建lv</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# lvcreate -n data -L +10G mydata
WARNING: xfs signature detected on /dev/mydata/data at offset 0. Wipe it? [y/n]: y
  Wiping xfs signature on /dev/mydata/data.
  Logical volume "data" created.
[root@132 ~]# lvcreate -n logs -L +10G mydata
  Logical volume "logs" created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>5、创建文件系统</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# mkfs.ext4 /dev/mydata/data
mke2fs 1.42.9 (28-Dec-2013)
文件系统标签=
OS type: Linux
块大小=4096 (log=2)
分块大小=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
655360 inodes, 2621440 blocks
131072 blocks (5.00%) reserved for the super user
第一个数据块=0
Maximum filesystem blocks=2151677952
80 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: 完成
正在写入inode表: 完成
Creating journal (32768 blocks): 完成
Writing superblocks and filesystem accounting information: 完成

[root@132 ~]# mkfs.xfs /dev/mydata/logs
meta-data=/dev/mydata/logs       isize=512    agcount=4, agsize=655360 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=2621440, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>6、临时挂载</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# mkdir /data
[root@132 ~]# mount /dev/mapper/mydata-data /data/
[root@132 ~]# mkdir /opt/logs
[root@132 ~]# mount /dev/mapper/mydata-logs /opt/logs/
[root@132 ~]# df -h
/dev/mapper/mydata-data  9.8G   37M  9.2G    1% /data
/dev/mapper/mydata-logs   10G   33M   10G    1% /opt/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>7、永久挂载</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# blkid
/dev/mapper/mydata-data: UUID="1cf7256a-bc3a-4bbe-aab9-5f6df6a273d5" TYPE="ext4"
/dev/mapper/mydata-logs: UUID="3db3797f-b85d-4c2c-bfec-6a3b721026c5" TYPE="xfs"
[root@132 ~]# tail -n 2 /etc/fstab
UUID=1cf7256a-bc3a-4bbe-aab9-5f6df6a273d5 /data         ext4    defaults        0 0
UUID=3db3797f-b85d-4c2c-bfec-6a3b721026c5 /opt/logs     xfs     defaults        0 0
[root@132 ~]# mount -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="lvm扩容"><a href="#lvm扩容" class="headerlink" title="lvm扩容"></a>lvm扩容</h1><p>这个比较常用也简单，大体思路为：<code>新增磁盘或分区--&gt;创建PV--&gt;扩容VG--&gt;扩容LV--&gt;扩容文件系统</code>。</p>
<table>
<thead>
<tr>
<th>磁盘</th>
<th>磁盘大小</th>
<th>新增pv</th>
<th>PV大小</th>
<th>扩容vg</th>
</tr>
</thead>
<tbody><tr>
<td>/dev/sdb</td>
<td>20G</td>
<td>/dev/sdb2</td>
<td>10G</td>
<td>mydata</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>扩容lv</th>
<th>所属vg</th>
<th>扩容大小</th>
<th>文件系统</th>
<th>挂载点</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>data</td>
<td>mydata</td>
<td>+5G</td>
<td>ext4</td>
<td>/data</td>
<td>存储数据</td>
</tr>
<tr>
<td>logs</td>
<td>mydata</td>
<td>+5G</td>
<td>xfs</td>
<td>/opt/logs</td>
<td>存储日志</td>
</tr>
</tbody></table>
<p><strong>1、磁盘分区</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# fdisk /dev/sdb     # 创建/dev/sdb2，大小10G，选择8e格式。
[root@132 ~]# partprobe	  		 # 内核重新加载磁盘分区信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>2、创建pv</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# pvcreate /dev/sdb2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>3、扩容vg</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# vgextend mydata /dev/sdb2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>4、扩容lv</strong></p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# lvextend -L +5G /dev/mydata/data
[root@132 ~]# lvextend -L +5G /dev/mydata/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>5、扩容文件系统</strong></p>
<p>对于文件系统，需要根据其文件系统格式对其进行动态的增长。</p>
<ul>
<li>xfs文件系统使用xfs_growfs</li>
<li>ext2、ext3、ext4文件系统使用resize2fs </li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# resize2fs /dev/mapper/mydata-data			# ext4文件系统使用resize2fs动态调整
[root@132 ~]# xfs_growfs /dev/mapper/mydata-logs		# xfs文件系统使用xfs_growfs动态扩容
[root@132 ~]# df -h
/dev/mapper/mydata-data   15G   41M   14G    1% /data
/dev/mapper/mydata-logs   15G   33M   15G    1% /opt/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="lvm缩容"><a href="#lvm缩容" class="headerlink" title="lvm缩容"></a>lvm缩容</h1><h2 id="xfs文件系统"><a href="#xfs文件系统" class="headerlink" title="xfs文件系统"></a>xfs文件系统</h2><p>centos7.x默认使用xfs格式的文件系统，而我们前面讲到xfs格式的文件系统不支持动态缩容，但有时我们却需要对其进行缩容，那应该怎么做？</p>
<p>笔者遇到的情况：</p>
<p>申请虚拟机的时候，申请磁盘大小为500G，到手之后，发现我的/home目录大小为341G，而/目录却只有50G（经询问，是其虚拟机安装模板原因导致），这是极其不合理。</p>
<p>在使用过程中发现，因为使用习惯的不同，/目录空间严重不足，但/home目录空间却及其充裕，只能想办法将/home的容量转移到/目录下。</p>
<pre class="line-numbers language-none"><code class="language-none">$ df -hT
Filesystem              Type      Size  Used Avail Use% Mounted on
/dev/mapper/centos-root xfs        50G   33G   18G  65% /
devtmpfs                devtmpfs  7.8G     0  7.8G   0% /dev
tmpfs                   tmpfs     7.8G     0  7.8G   0% /dev/shm
tmpfs                   tmpfs     7.8G  754M  7.1G  10% /run
tmpfs                   tmpfs     7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/vda1               xfs      1014M  145M  870M  15% /boot
/dev/mapper/centos-home xfs       341G  512M  341G   1% /home
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>1、整体思路</strong></p>
<p>1、备份/home分区（xfsdump、dd）<br>2、归还/home占用的lv<br>3、创建新的/dev/mapper/centos-home<br>4、创建文件系统并挂载使用<br>5、将归还的容量在线扩容至/分区</p>
<p><strong>2、安装xfsdump</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ yum install xfsdump.x86_64 -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>3、查看是否有进程占用/home目录</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ fuser -u -v -m /home/
                     USER        PID ACCESS COMMAND
/home:               root     kernel mount (root)/home
                     root      91618 F.ce. (root)redis-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到有一个redis-server在/home目录下运行，可以手动去关闭占用/home目录的进程，也可以直接干掉。</p>
<p>因为我这里的redis服务是自己单独搭建的，没有什么特别用处，所以直接干掉。</p>
<pre class="line-numbers language-none"><code class="language-none">fuser -u -m -v -k -i /home/
                     USER        PID ACCESS COMMAND
/home:               root     kernel mount (root)/home
                     root      91618 F.ce. (root)redis-server
Kill process 91618 ? (y/N) y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>4、备份/home分区</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ xfsdump -l 0 -L home -M home -f /mnt/home.xfsdump /home
xfsdump: using file dump (drive_simple) strategy
xfsdump: version 3.1.7 (dump format 3.0) - type ^C for status and control
xfsdump: level 0 dump of master:/home
xfsdump: dump date: Thu Jul  4 16:23:12 2019
xfsdump: session id: 80a42690-a616-42a8-97cb-8c21b1f1ca60
xfsdump: session label: "home"
xfsdump: ino map phase 1: constructing initial dump list
xfsdump: ino map phase 2: skipping (no pruning necessary)
xfsdump: ino map phase 3: skipping (only one dump stream)
xfsdump: ino map construction complete
xfsdump: estimated dump size: 501980992 bytes
xfsdump: creating dump session media file 0 (media 0, file 0)
xfsdump: dumping ino map
xfsdump: dumping directories
xfsdump: dumping non-directory files
xfsdump: ending media file
xfsdump: media file size 499016800 bytes
xfsdump: dump size (non-dir files) : 498318632 bytes
xfsdump: dump complete: 0 seconds elapsed
xfsdump: Dump Summary:
xfsdump:   stream 0 /mnt/home.xfsdump OK (success)
xfsdump: Dump Status: SUCCESS
$ ll /mnt/home.xfsdump
-rw-r--r-- 1 root root 499016800 Jul  4 16:23 /mnt/home.xfsdump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>5、卸载/home目录</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ umount /home/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>6、调整/home目录大小</strong></p>
<pre class="line-numbers language-none"><code class="language-none">lvreduce -L 50G /dev/centos/home
  WARNING: Reducing active logical volume to 50.00 GiB.
  THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce centos/home? [y/n]: y
  Size of logical volume centos/home changed from &lt;341.12 GiB (87326 extents) to 50.00 GiB (12800 extents).
  Logical volume centos/home successfully resized.
$ lvs
  LV   VG     Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  home centos -wi-a----- 50.00g
  root centos -wi-ao---- 50.00g
  swap centos -wi-a----- &lt;7.88g
$ vgs
  VG     #PV #LV #SN Attr   VSize    VFree
  centos   1   3   0 wz--n- &lt;399.00g 291.12g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>7、扩容/分区</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ lvextend -L +290G /dev/centos/root
  Size of logical volume centos/root changed from 50.00 GiB (12800 extents) to 340.00 GiB (87040 extents).
  Logical volume centos/root successfully resized.
$ xfs_growfs /dev/mapper/centos-root
meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=3276800 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=13107200, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=6400, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 13107200 to 89128960
$ df -hT
Filesystem              Type      Size  Used Avail Use% Mounted on
/dev/mapper/centos-root xfs       340G   33G  308G  10% /
devtmpfs                devtmpfs  7.8G     0  7.8G   0% /dev
tmpfs                   tmpfs     7.8G     0  7.8G   0% /dev/shm
tmpfs                   tmpfs     7.8G  754M  7.1G  10% /run
tmpfs                   tmpfs     7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/vda1               xfs      1014M  145M  870M  15% /boot
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到/目录已经增大了</p>
<p><strong>8、格式化/home所在lv</strong></p>
<p>接下来需要重新格式化下/home分区，若不格式化，而直接挂载会提示无法读取设备</p>
<pre class="line-numbers language-none"><code class="language-none">$ mount /dev/mapper/centos-home /home/
mount: /dev/mapper/centos-home: can't read superblock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>格式化</p>
<pre class="line-numbers language-none"><code class="language-none">$ mkfs.xfs -f /dev/mapper/centos-home
meta-data=/dev/mapper/centos-home isize=512    agcount=4, agsize=3276800 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=13107200, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=6400, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">$ mount /dev/mapper/centos-home /home/
$ df -hT
/dev/mapper/centos-home xfs        50G   33M   50G   1% /home<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>9、还原备份的数据</strong> </p>
<pre class="line-numbers language-none"><code class="language-none">$ xfsrestore -f /mnt/home.xfsdump /home/
xfsrestore: using file dump (drive_simple) strategy
xfsrestore: version 3.1.7 (dump format 3.0) - type ^C for status and control
xfsrestore: searching media for dump
xfsrestore: examining media file 0
xfsrestore: dump description:
xfsrestore: hostname: master
xfsrestore: mount point: /home
xfsrestore: volume: /dev/mapper/centos-home
xfsrestore: session time: Thu Jul  4 16:23:12 2019
xfsrestore: level: 0
xfsrestore: session label: "home"
xfsrestore: media label: "home"
xfsrestore: file system id: 9353acc1-1f16-4599-a6ba-614a088b3d9f
xfsrestore: session id: 80a42690-a616-42a8-97cb-8c21b1f1ca60
xfsrestore: media id: 11205bc3-acf3-44a4-9ccb-8444c7a3bafe
xfsrestore: using online session inventory
xfsrestore: searching media for directory dump
xfsrestore: reading directories
xfsrestore: 250 directories and 2072 entries processed
xfsrestore: directory post-processing
xfsrestore: restoring non-directory files
xfsrestore: restore complete: 1 seconds elapsed
xfsrestore: Restore Summary:
xfsrestore:   stream 0 /mnt/home.xfsdump OK (success)
xfsrestore: Restore Status: SUCCESS

$ df -hT
/dev/mapper/centos-home xfs        50G  512M   50G   1% /home<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>10、重新启动redis-server服务</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ fuser -u -m -v /home/
                     USER        PID ACCESS COMMAND
/home:               root     kernel mount (root)/home
                     root      30684 F.c.. (root)redis-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ext4文件系统"><a href="#ext4文件系统" class="headerlink" title="ext4文件系统"></a>ext4文件系统</h2><p>前面我们讲过ext4是支持动态缩容的，首先我们来了解缩容的流程（动态缩容也是遵循这个流程的）：</p>
<ol>
<li><p>卸载已经挂载的逻辑卷</p>
<pre class="line-numbers language-none"><code class="language-none">$ umount /dev/mapper/centos-test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>缩小文件系统</p>
<pre class="line-numbers language-none"><code class="language-none">$ resize2fs /dev/mapper/centos-test 12G
resize2fs 1.42.9 (28-Dec-2013)
Resizing the filesystem on /dev/mapper/centos-test to 3145728 (4k) blocks.
The filesystem on /dev/mapper/centos-test is now 3145728 blocks long.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>检查文件系统</p>
<pre class="line-numbers language-none"><code class="language-none">$ e2fsck /dev/mapper/centos-test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>缩小lv</p>
<pre class="line-numbers language-none"><code class="language-none">$ lvreduce -L -1G /dev/mapper/centos-test
  WARNING: Reducing active logical volume to 12.00 GiB.
  THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce centos/test? [y/n]: y
  Size of logical volume centos/test changed from 13.00 GiB (3328 extents) to 12.00 GiB (3072 extents).
  Logical volume centos/test successfully resized.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>挂载</p>
<pre class="line-numbers language-none"><code class="language-none">mount /dev/mapper/centos-test /mnt/test/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<blockquote>
<p>需要确保文件系统缩减的大小和lv缩减的大小一致。</p>
</blockquote>
<p><strong>动态缩容</strong></p>
<pre class="line-numbers language-none"><code class="language-none">$ lvresize --resizefs --size 15G /dev/centos/test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p><code>--size</code>指定LV和文件系统的新大小，例如15G。 <code>--resizefs</code>指定调整lv大小的同时调整其已有文件系统的大小。 它比<code>resize2fs</code> + <code>lvresize</code>更好，因为管理员不太可能意外地为<code>resize2fs</code>和<code>lvresize</code>使用不一致的参数（即lv和文件系统的大小保持一致）。</p>
<p><code>lvreduce -r</code>也可实现同时缩小lv和文件系统。</p>
</blockquote>
<p><strong>缩小vg</strong></p>
<p>一般缩容了lv，其容量会归还到所属vg中，但是有时候我们并不是仅仅想缩容文件系统和lv，而是要归还底层提供存储的磁盘，那么就需要继续缩容vg和pv。</p>
<p>vg的缩容是通过删除vg中的pv来减少vg容量的，删除vg中的pv时，首先要查看是否有文件系统的数据存储在该pv上，如果有，需要先将该pv中的数据迁移到同vg中其他的pv上：</p>
<p>查看vg中所有pv的详细信息：通过<code>-m</code>参数查看pv和lv的映射关系</p>
<pre class="line-numbers language-none"><code class="language-none">[root@132 ~]# pvdisplay -m /dev/sdb /dev/sdc
  --- Physical volume ---
  PV Name               /dev/sdb
  VG Name               centos
  PV Size               20.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              5119
  Free PE               2047
  Allocated PE          3072
  PV UUID               Sz7PEo-5Bxx-oo1s-4Amf-PzLg-rGcW-sP7EWY

  --- Physical Segments ---
  Physical extent 0 to 3071:
    Logical volume      /dev/centos/test
    Logical extents     0 to 3071
  Physical extent 3072 to 5118:
    FREE

  --- Physical volume ---
  PV Name               /dev/sdc
  VG Name               centos
  PV Size               15.00 GiB / not usable 4.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              3839
  Free PE               3839
  Allocated PE          0
  PV UUID               E1Hd9x-JiAH-5JRB-eoeE-LEmu-Y9iO-6rg4DP

  --- Physical Segments ---
  Physical extent 0 to 3838:
    FREE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到<code>pv：/dev/sdb</code>的物理片段：0-3071被<code>lv：/dev/centos/test</code>所使用（即PE:0-3071对应LE:0-3071），因此我们需要将该部分PE迁移到<code>pv：/dev/sdc</code>上。</p>
<p>确保同属<code>vg：centos</code>中的<code>pv：/dev/sdc</code>剩余的空间大于<code>pv：/dev/sdb</code>要迁移的数据大小。</p>
<p>迁移：</p>
<pre class="line-numbers language-none"><code class="language-none">$ pvmove /dev/sdb:0-3071 /dev/sdc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>迁移完成后，删除vg中的<code>pv：/dev/sdb</code></p>
<pre class="line-numbers language-none"><code class="language-none">$ vgreduce centos /dev/sdb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除pv</p>
<pre class="line-numbers language-none"><code class="language-none">pvremove /dev/sdb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>到此便可退还磁盘/dev/sdb。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我们发现，xfs格式的文件系统在缩容时候，若文件系统上有服务，会导致服务的暂停。</p>
<p>这还是基于lvm分区方式，若采用非lvm方式（传统分区方式），那么不论何种文件类型的文件系统，扩容和缩容都是会导致服务的中断，这在生产环境是难以接受的。</p>
<p>因此，我们需要在项目开始时尽可能确定好磁盘分区方式和文件类型，规划好磁盘空间，避免出现需暂停服务的情况。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">bestmem</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://bestmem.github.io/2022/09/01/linux/%E7%A3%81%E7%9B%98/lvm%E5%AE%9E%E8%B7%B5/">https://bestmem.github.io/2022/09/01/linux/%E7%A3%81%E7%9B%98/lvm%E5%AE%9E%E8%B7%B5/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">bestmem</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/linux/">
                                    <span class="chip bg-color">linux</span>
                                </a>
                            
                                <a href="/tags/lvm/">
                                    <span class="chip bg-color">lvm</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/10/20/zabbix/zabbix6.0%E5%8F%91%E7%8E%B0/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="zabbix6.0 Discovery">
                        
                        <span class="card-title">zabbix6.0 Discovery</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/zabbix/" class="post-category">
                                    zabbix
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/zabbix/">
                        <span class="chip bg-color">zabbix</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/09/01/linux/%E7%A3%81%E7%9B%98/%E4%BC%A0%E7%BB%9F%E5%88%86%E5%8C%BA%E6%89%A9%E5%AE%B9/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="传统分区扩容">
                        
                        <span class="card-title">传统分区扩容</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-09-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/linux/" class="post-category">
                                    linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="7503460355"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.1'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">bestmem</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">22.8k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "6";
                        var startDate = "21";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">














</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
